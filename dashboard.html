<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Documentos - AtomoTech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .header {
            background-color: #0d47a1;
        }
        .tab-button.active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }
        .table-row-hover:hover {
            background-color: #f1f5f9;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="header text-white p-4 shadow-lg fixed top-0 left-0 right-0 z-50">
        <div class="container mx-auto flex items-center justify-between">
            <button onclick="window.history.back();" class="text-white hover:text-gray-200 transition-colors mr-4">
                <i class="fas fa-arrow-left text-xl"></i>
            </button>
            
            <div class="flex items-center">
                <img src="logo.png" alt="AtomoTech Logo" class="h-8 mr-2">
                <h1 class="text-3xl font-bold">AtomoTech19</h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <span id="user-status" class="text-sm font-medium">Conectando...</span>
            </div>
        </div>
    </header>

    <main class="flex-1 mt-20 p-4 sm:p-6 lg:p-8">
        <div class="container mx-auto">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Gerenciar Documentos</h2>
            
            <div class="flex mb-4 border-b border-gray-200">
                <button id="orcamento-tab" class="tab-button active px-4 py-2 font-medium text-gray-600 hover:text-blue-500 transition-colors">Orçamentos</button>
                <button id="os-tab" class="tab-button px-4 py-2 font-medium text-gray-600 hover:text-blue-500 transition-colors">Ordens de Serviço</button>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h3 class="text-lg font-semibold mb-4">Filtros</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label for="status-filter" class="block text-sm font-medium text-gray-700">Status</label>
                        <select id="status-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            <option value="">Todos</option>
                            <option value="Pendente">Pendente</option>
                            <option value="Aprovado">Aprovado</option>
                            <option value="Rejeitado">Rejeitado</option>
                            <option value="Concluído">Concluído</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div>
                        <label for="cliente-filter" class="block text-sm font-medium text-gray-700">Cliente</label>
                        <input type="text" id="cliente-filter" placeholder="Nome do Cliente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="start-date-filter" class="block text-sm font-medium text-gray-700">Data Inicial</label>
                        <input type="date" id="start-date-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="end-date-filter" class="block text-sm font-medium text-gray-700">Data Final</label>
                        <input type="date" id="end-date-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button onclick="applyFilters()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors">Aplicar Filtros</button>
                    <button onclick="resetFilters()" class="px-4 py-2 ml-2 bg-gray-300 text-gray-800 rounded-lg shadow hover:bg-gray-400 transition-colors">Limpar Filtros</button>
                </div>
            </div>
            
            <div id="orcamento-content" class="tab-content bg-white p-6 rounded-lg shadow-md">
                <div id="loading-spinner" class="flex items-center justify-center p-4 hidden">
                    <div class="loader"></div>
                    <span class="ml-2 text-gray-500">Carregando...</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Documento</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="orcamentos-list" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Nenhum documento encontrado.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="os-content" class="tab-content hidden bg-white p-6 rounded-lg shadow-md">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Documento</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="os-list" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Nenhum documento encontrado.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="debug-output" class="mt-6 p-4 bg-gray-800 text-gray-100 rounded-lg shadow-inner font-mono">
                <h3 class="font-bold mb-2">Saída de Depuração</h3>
                <pre id="debug-pre"></pre>
            </div>
            <button onclick="toggleDebugOutput()" class="mt-4 px-4 py-2 bg-gray-600 text-white rounded-lg shadow hover:bg-gray-700 transition-colors">Exibir/Ocultar Depuração</button>
        </div>
    </main>

    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full shadow-lg overflow-y-auto max-h-[90vh]">
            <h3 class="text-xl font-bold mb-4" id="edit-modal-title">Editar Documento</h3>
            <form id="edit-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="cliente-nome" class="block text-sm font-medium text-gray-700">Nome do Cliente</label>
                        <input type="text" id="cliente-nome" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="cliente-email" class="block text-sm font-medium text-gray-700">Email do Cliente</label>
                        <input type="email" id="cliente-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="cliente-telefone" class="block text-sm font-medium text-gray-700">Telefone do Cliente</label>
                        <input type="text" id="cliente-telefone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="data-documento" class="block text-sm font-medium text-gray-700">Data do Documento</label>
                        <input type="date" id="data-documento" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div id="condicao-pagamento-div" class="hidden">
                        <label for="condicao-pagamento" class="block text-sm font-medium text-gray-700">Condições de Pagamento</label>
                        <input type="text" id="condicao-pagamento" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div id="valor-total-div">
                        <label for="valor-total" class="block text-sm font-medium text-gray-700">Valor Total</label>
                        <input type="number" id="valor-total" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" step="0.01">
                    </div>
                    <div>
                        <label for="status-documento" class="block text-sm font-medium text-gray-700">Status</label>
                        <select id="status-documento" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="Pendente">Pendente</option>
                            <option value="Aprovado">Aprovado</option>
                            <option value="Rejeitado">Rejeitado</option>
                            <option value="Concluído">Concluído</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div id="validaded-div" class="hidden">
                         <label for="validade" class="block text-sm font-medium text-gray-700">Validade (dias)</label>
                         <input type="number" id="validade" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                </div>

                <div class="mt-6">
                    <h4 class="text-lg font-semibold mb-2">Itens</h4>
                    <div id="itens-container"></div>
                    <button type="button" onclick="addEditItem()" class="mt-4 px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition-colors">Adicionar Item</button>
                </div>
            </form>

            <div class="mt-6 flex justify-end space-x-2">
                <button onclick="saveDocument()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition-colors">Salvar Alterações</button>
                <button onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow hover:bg-gray-400 transition-colors">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-lg">
            <h3 id="message-title" class="text-lg font-bold mb-2"></h3>
            <p id="message-body" class="mb-4"></p>
            <div class="flex justify-end">
                <button onclick="closeModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let db, authInstance;
        let userId = null;
        let activeCollection = 'orcamentos';
        let currentDocuments = [];
        let editingDocId = null;

        const firebaseConfig = {
            apiKey: "AIzaSyBD5NJXU1YBb1tbWAtaO8tyx21x5UwDs58",
            authDomain: "atomotech-gestao.firebaseapp.com",
            projectId: "atomotech-gestao",
            storageBucket: "atomotech-gestao.firebasestorage.app",
            messagingSenderId: "307660458127",
            appId: "1:307660458127:web:853844133b6cf7c7e788fa",
            measurementId: "G-WB5BZPR532"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

        // --- Funções de Modal para Mensagens e Feedback ---
        function showMessage(title, body) {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-body').textContent = body;
            document.getElementById('message-modal').classList.remove('hidden');
        }
        
        function closeModal() {
            document.getElementById('message-modal').classList.add('hidden');
        }

        function showLoading() {
            document.getElementById('loading-spinner').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loading-spinner').classList.add('hidden');
        }

        function toggleDebugOutput() {
            const debugDiv = document.getElementById('debug-output');
            debugDiv.classList.toggle('hidden');
        }
        
        // --- Funções do Modal de Edição ---
        function openEditModal(docId, collectionName) {
            editingDocId = docId;
            activeCollection = collectionName;
            
            const docData = currentDocuments.find(d => d.id === docId);
            if (!docData) {
                showMessage('Erro', 'Documento não encontrado para edição.');
                return;
            }

            // Popula o formulário com os dados do documento
            document.getElementById('cliente-nome').value = docData.cliente?.nome || '';
            document.getElementById('cliente-email').value = docData.cliente?.email || '';
            document.getElementById('cliente-telefone').value = docData.cliente?.telefone || '';
            document.getElementById('data-documento').value = docData.data || '';
            document.getElementById('status-documento').value = docData.status || 'Pendente';
            document.getElementById('valor-total').value = docData.valor_total || 0;
            
            // Campos específicos para orçamento
            const condicaoPagamentoDiv = document.getElementById('condicao-pagamento-div');
            const validadeDiv = document.getElementById('validaded-div');
            if (collectionName === 'orcamentos') {
                condicaoPagamentoDiv.classList.remove('hidden');
                validadeDiv.classList.remove('hidden');
                document.getElementById('condicao-pagamento').value = docData.condicoes_pagamento || '';
                document.getElementById('validade').value = docData.validade || '';
                document.getElementById('edit-modal-title').textContent = `Editar Orçamento #${docId}`;
            } else {
                condicaoPagamentoDiv.classList.add('hidden');
                validadeDiv.classList.add('hidden');
                document.getElementById('edit-modal-title').textContent = `Editar OS #${docId}`;
            }

            renderEditItems(docData.itens || []);
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        function renderEditItems(itens) {
            const container = document.getElementById('itens-container');
            container.innerHTML = '';
            itens.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'grid grid-cols-1 md:grid-cols-4 gap-2 mb-2 p-2 bg-gray-50 rounded-md';
                itemDiv.innerHTML = `
                    <input type="text" placeholder="Descrição" value="${item.descricao || ''}" class="col-span-1 md:col-span-2 p-2 border rounded-md item-descricao">
                    <input type="number" placeholder="Qtd" value="${item.qtd || 0}" class="p-2 border rounded-md item-qtd">
                    <input type="number" placeholder="Valor Unitário" value="${item.valor_unit || 0}" class="p-2 border rounded-md item-valor-unit" step="0.01">
                    <button type="button" class="px-2 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600" onclick="this.parentElement.remove();">Remover</button>
                `;
                container.appendChild(itemDiv);
            });
        }

        function addEditItem() {
            const container = document.getElementById('itens-container');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'grid grid-cols-1 md:grid-cols-4 gap-2 mb-2 p-2 bg-gray-50 rounded-md';
            itemDiv.innerHTML = `
                <input type="text" placeholder="Descrição" class="col-span-1 md:col-span-2 p-2 border rounded-md item-descricao">
                <input type="number" placeholder="Qtd" value="1" class="p-2 border rounded-md item-qtd">
                <input type="number" placeholder="Valor Unitário" value="0" class="p-2 border rounded-md item-valor-unit" step="0.01">
                <button type="button" class="px-2 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600" onclick="this.parentElement.remove();">Remover</button>
            `;
            container.appendChild(itemDiv);
        }

        async function saveDocument() {
            if (!editingDocId || !userId) {
                showMessage('Erro', 'Não foi possível salvar o documento.');
                return;
            }

            // CORRIGIDO: Alterado o caminho para corresponder à estrutura do seu banco de dados.
            const docsPath = `public/data/${activeCollection}`;
            const docRef = doc(db, docsPath, editingDocId);
            const updatedData = getFormData();
            
            try {
                await updateDoc(docRef, updatedData);
                closeEditModal();
                showMessage('Sucesso', 'Documento atualizado com sucesso!');
            } catch (error) {
                console.error("Erro ao salvar o documento:", error);
                showMessage('Erro', 'Não foi possível salvar as alterações.');
            }
        }
        
        async function deleteDocument(docId) {
            if (!docId || !userId) {
                showMessage('Erro', 'Não foi possível deletar o documento.');
                return;
            }

            const confirmDeletion = await new Promise(resolve => {
                const confirmModal = document.createElement('div');
                confirmModal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50';
                confirmModal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-lg">
                        <h3 class="text-lg font-bold mb-2">Confirmar Exclusão</h3>
                        <p class="mb-4">Tem certeza que deseja deletar este documento?</p>
                        <div class="flex justify-end space-x-2">
                            <button id="confirm-yes" class="px-4 py-2 bg-red-600 text-white rounded-lg shadow hover:bg-red-700">Sim</button>
                            <button id="confirm-no" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow hover:bg-gray-400">Não</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmModal);

                document.getElementById('confirm-yes').onclick = () => {
                    document.body.removeChild(confirmModal);
                    resolve(true);
                };
                document.getElementById('confirm-no').onclick = () => {
                    document.body.removeChild(confirmModal);
                    resolve(false);
                };
            });

            if (confirmDeletion) {
                // CORRIGIDO: Alterado o caminho para corresponder à estrutura do seu banco de dados.
                const docsPath = `public/data/${activeCollection}`;
                const docRef = doc(db, docsPath, docId);
                try {
                    await deleteDoc(docRef);
                    showMessage('Sucesso', 'Documento deletado com sucesso!');
                } catch (error) {
                    console.error("Erro ao deletar o documento:", error);
                    showMessage('Erro', 'Não foi possível deletar o documento.');
                }
            }
        }

        function getFormData() {
            const itens = [];
            document.querySelectorAll('#itens-container > div').forEach(itemDiv => {
                const descricao = itemDiv.querySelector('.item-descricao').value;
                const qtd = parseFloat(itemDiv.querySelector('.item-qtd').value) || 0;
                const valor_unit = parseFloat(itemDiv.querySelector('.item-valor-unit').value) || 0;
                itens.push({
                    descricao: descricao,
                    qtd: qtd,
                    valor_unit: valor_unit
                });
            });

            const data = {
                cliente: {
                    nome: document.getElementById('cliente-nome').value,
                    email: document.getElementById('cliente-email').value,
                    telefone: document.getElementById('cliente-telefone').value
                },
                data: document.getElementById('data-documento').value,
                status: document.getElementById('status-documento').value,
                valor_total: parseFloat(document.getElementById('valor-total').value),
                itens: itens
            };

            if (activeCollection === 'orcamentos') {
                data.condicoes_pagamento = document.getElementById('condicao-pagamento').value;
                data.validade = document.getElementById('validade').value;
            }
            return data;
        }
        
        async function generatePdfFromData(docData, docId, collectionName) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const docType = collectionName === 'orcamentos' ? 'Orçamento de Serviço' : 'Ordem de Serviço';

            doc.setFontSize(22);
            doc.text(docType, 10, 20);

            doc.setFontSize(14);
            doc.text(`Documento: ${docId}`, 10, 30);
            doc.text(`Data: ${docData.data}`, 10, 40);
            doc.text(`Status: ${docData.status}`, 10, 50);

            let y = 60;
            doc.setFontSize(16);
            doc.text("Informações do Cliente", 10, y + 10);
            doc.setFontSize(12);
            doc.text(`Nome: ${docData.cliente?.nome || 'N/A'}`, 10, y + 20);
            doc.text(`Telefone: ${docData.cliente?.telefone || 'N/A'}`, 10, y + 27);
            doc.text(`Email: ${docData.cliente?.email || 'N/A'}`, 10, y + 34);

            if (collectionName === 'orcamentos') {
                doc.text(`Validade: ${docData.validade || 'N/A'} dias`, 100, y + 20);
                doc.text(`Condições de Pagamento: ${docData.condicoes_pagamento || 'N/A'}`, 100, y + 27);
            }

            y += 50;
            doc.setFontSize(16);
            doc.text("Itens do Documento", 10, y);
            y += 10;

            const tableColumn = ["Descrição", "Qtd", "Valor Unit.", "Total"];
            const tableRows = (docData.itens || []).map(item => [
                item.descricao, 
                item.qtd, 
                `R$ ${item.valor_unit.toFixed(2).replace('.', ',')}`, 
                `R$ ${(item.qtd * item.valor_unit).toFixed(2).replace('.', ',')}`
            ]);

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: y,
                theme: 'striped',
                headStyles: { fillColor: [13, 71, 161] } // Cor do header (Azul AtomoTech)
            });
            
            y = doc.autoTable.previous.finalY + 10;
            doc.setFontSize(14);
            doc.text(`Total: R$ ${docData.valor_total.toFixed(2).replace('.', ',')}`, 10, y + 10);

            doc.save(`${docId}.pdf`);
            showMessage('PDF Gerado', 'O PDF do documento foi gerado com sucesso!');
        }
        
        // --- Inicialização do Firebase ---
        function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                authInstance = getAuth(app);
                
                onAuthStateChanged(authInstance, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-status').textContent = `Conectado como: ${userId}`;
                        console.log("Usuário autenticado. UID:", userId);
                        subscribeToDocuments(activeCollection);
                    } else {
                        console.log("Usuário não autenticado. Tentando entrar com token...");
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(authInstance, initialAuthToken);
                            } catch(e) {
                                console.error("Erro ao autenticar com token:", e);
                                showMessage('Erro Crítico', `Não foi possível inicializar a aplicação: Firebase: ${e.code}. Verifique a chave de API.`);
                            }
                        } else {
                            await signInAnonymously(authInstance);
                        }
                    }
                });
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                showMessage('Erro de Inicialização', 'Ocorreu um erro ao inicializar o Firebase. Verifique a configuração.');
            }
        }
        
        // --- Assinar coleções com onSnapshot para atualizações em tempo real ---
        let unsubscribe = null;
        function subscribeToDocuments(collectionName) {
            if (!userId) {
                console.error("Usuário não autenticado, não é possível assinar a coleção.");
                return;
            }

            if (unsubscribe) {
                unsubscribe();
            }

            showLoading();
            // CORRIGIDO: Alterado o caminho para corresponder à estrutura do seu banco de dados.
            const docsPath = `public/data/${collectionName}`;
            const docsRef = collection(db, docsPath);
            
            console.log(`Buscando documentos na coleção: ${docsPath}`);

            unsubscribe = onSnapshot(docsRef, (snapshot) => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentDocuments = data;
                
                // Saída de depuração
                console.log(`Dados brutos recebidos para '${collectionName}':`, data);
                document.getElementById('debug-pre').textContent = JSON.stringify(data, null, 2);

                applyFilters();
                hideLoading();
            }, (error) => {
                console.error("Erro ao assinar a coleção:", error);
                showMessage('Erro de Dados', 'Não foi possível carregar os documentos em tempo real. Verifique o console.');
                hideLoading();
            });
        }
        
        // --- Renderizar documentos na tabela ---
        function renderDocuments(documents, listElementId) {
            const listElement = document.getElementById(listElementId);
            listElement.innerHTML = '';
            if (documents.length === 0) {
                listElement.innerHTML = `<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Nenhum documento encontrado.</td></tr>`;
                return;
            }
            
            documents.forEach(doc => {
                const tr = document.createElement('tr');
                tr.className = 'table-row-hover';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${doc.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.cliente?.nome || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.data || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="font-semibold" style="color: ${getStatusColor(doc.status)};">
                            ${doc.status || 'N/A'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                        <button onclick="openEditModal('${doc.id}', '${activeCollection}')" class="text-indigo-600 hover:text-indigo-900">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteDocument('${doc.id}')" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <button onclick="generatePdf('${doc.id}', '${activeCollection}')" class="text-blue-600 hover:text-blue-900">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                    </td>
                `;
                listElement.appendChild(tr);
            });
        }

        // --- Lógica de Filtros ---
        function applyFilters() {
            showLoading();
            const status = document.getElementById('status-filter').value;
            const cliente = document.getElementById('cliente-filter').value.toLowerCase();
            const startDate = document.getElementById('start-date-filter').value;
            const endDate = document.getElementById('end-date-filter').value;

            console.log("Filtros aplicados:", { status, cliente, startDate, endDate });

            // Atraso artificial para que o usuário consiga ver o feedback de carregamento
            setTimeout(() => {
                const filteredDocs = currentDocuments.filter(doc => {
                    const matchStatus = !status || doc.status === status;
                    const matchCliente = !cliente || (doc.cliente?.nome && doc.cliente.nome.toLowerCase().includes(cliente));
                    
                    const docDate = doc.data ? new Date(doc.data) : null;
                    const matchStartDate = !startDate || (docDate && docDate >= new Date(startDate));
                    const matchEndDate = !endDate || (docDate && docDate <= new Date(endDate));

                    return matchStatus && matchCliente && matchStartDate && matchEndDate;
                });
                
                console.log("Documentos filtrados:", filteredDocs);

                const listElementId = activeCollection === 'orcamentos' ? 'orcamentos-list' : 'os-list';
                renderDocuments(filteredDocs, listElementId);
                hideLoading();
            }, 1000); // 1 segundo de atraso
        }

        function resetFilters() {
            document.getElementById('status-filter').value = '';
            document.getElementById('cliente-filter').value = '';
            document.getElementById('start-date-filter').value = '';
            document.getElementById('end-date-filter').value = '';
            applyFilters();
        }
        
        // --- Lógica de Abas ---
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    contents.forEach(content => content.classList.add('hidden'));
                    const targetId = tab.id.replace('-tab', '-content');
                    document.getElementById(targetId).classList.remove('hidden');
                    
                    activeCollection = tab.id.startsWith('orcamento') ? 'orcamentos' : 'ordens_servico';
                    subscribeToDocuments(activeCollection);
                });
            });
        }
        
        // --- Funções Auxiliares ---
        function getStatusColor(status) {
            switch (status) {
                case 'Aprovado':
                case 'Concluído':
                    return '#22c55e'; // green-500
                case 'Pendente':
                    return '#f97316'; // orange-500
                case 'Rejeitado':
                case 'Cancelado':
                    return '#ef4444'; // red-500
                default:
                    return '#6b7280'; // gray-500
            }
        }
        
        // --- Funções para gerar PDF diretamente da tabela ---
        async function generatePdf(docId, collectionName) {
            const docData = currentDocuments.find(d => d.id === docId);
            if (!docData) {
                showMessage('Erro', 'Documento não encontrado para gerar PDF.');
                return;
            }
            await generatePdfFromData(docData, docId, collectionName);
        }
        
        // --- Expor funções para o escopo global ---
        window.closeModal = closeModal;
        window.openEditModal = openEditModal;
        window.closeEditModal = closeEditModal;
        window.addEditItem = addEditItem;
        window.saveDocument = saveDocument;
        window.deleteDocument = deleteDocument;
        window.generatePdf = generatePdf;
        window.applyFilters = applyFilters;
        window.resetFilters = resetFilters;
        window.toggleDebugOutput = toggleDebugOutput;

        // Configuração inicial.
        window.onload = () => {
            initializeFirebase();
            setupTabs();
        };

        // Adiciona a biblioteca jsPDF para o autoTable
        window.jsPDF = window.jspdf.jsPDF;

    </script>
</body>
</html>
