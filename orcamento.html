<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orçamento - AtomoTech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            position: relative;
        }

        /* Adiciona a imagem de fundo com opacidade */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('logo.png'); /* Caminho corrigido para o arquivo logo.png */
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 400px;
            opacity: 0.05;
            z-index: -1;
        }

        /* Esconder apenas os botões de controle no PDF */
        .hide-on-pdf {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div id="orcamento-container" class="max-w-4xl mx-auto bg-white shadow-xl rounded-lg p-8">
        <div class="relative flex justify-between items-center mb-6">
            <span id="voltar-btn" class="absolute left-0 top-1/2 transform -translate-y-1/2 text-blue-500 hover:text-blue-700 transition-colors cursor-pointer">Voltar</span>
            <div class="flex-grow text-center">
                <h1 class="text-3xl font-bold text-gray-800 inline-block">Orçamento</h1>
            </div>
            <img src="logo.png" alt="Logo da AtomoTech" class="w-28 rounded-md ml-auto" onerror="this.onerror=null;this.src='https://placehold.co/150x50/e2e8f0/334155?text=AtomoTech';">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 text-sm">
            <div>
                <p class="font-bold text-gray-700">Orçamento:</p>
                <p id="orcamento-numero" class="text-gray-900 font-mono"></p>
            </div>
            <div>
                <p class="font-bold text-gray-700">Data:</p>
                <p id="data-atual" class="text-gray-900"></p>
            </div>
            <div>
                <div>
                <p class="font-bold text-gray-700">Validade1050:</p>
                <input id="validade-input" type="text" value="30 dias" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            </div>
            <div>
                <p class="font-bold text-gray-700">Condições de Pagamento:</p>
                <input id="condicoes-pagamento-input" type="text" value="Avista" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            <div>
                <p class="font-bold text-gray-700">Status:</p>
                <select id="status-select" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="Pendente">Pendente</option>
                    <option value="Aprovado">Aprovado</option>
                    <option value="Rejeitado">Rejeitado</option>
                    <option value="Cancelado">Cancelado</option>
                </select>
            </div>
        </div>

        <div class="mb-8 p-6 bg-gray-50 rounded-lg">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">Informações do Cliente</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input id="cliente-nome" type="text" placeholder="Nome" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                <input id="cliente-email" type="email" placeholder="Email" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                <input id="cliente-telefone" type="tel" placeholder="Telefone" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
        </div>

        <div class="overflow-x-auto mb-4">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3">Descrição</th>
                        <th scope="col" class="px-6 py-3">Qtd</th>
                        <th scope="col" class="px-6 py-3">Valor Unit.</th>
                        <th scope="col" class="px-6 py-3">Total</th>
                        <th scope="col" class="px-6 py-3"></th>
                    </tr>
                </thead>
                <tbody id="itens-tabela">
                    <!-- Itens serão adicionados aqui -->
                </tbody>
                <tfoot>
                    <tr class="font-semibold text-gray-900">
                        <td colspan="3" class="px-6 py-3 text-right">Total:</td>
                        <td id="total-orcamento" class="px-6 py-3 text-right">R$ 0,00</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <button id="add-item-btn" class="mb-8 px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">Adicionar Item</button>
        
        <div class="flex justify-end gap-4 mb-8">
            <button id="salvar-btn" class="px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">Salvar</button>
            <button id="gerar-pdf-btn" class="px-6 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors">Gerar PDF</button>
        </div>

        <div class="border-t pt-6 text-sm text-center text-gray-600">
            <p>Assinatura do Cliente</p>
        </div>
    </div>

    <!-- Script para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Function to show a custom message box
        const showMessage = (title, message, type = 'success') => {
            const messageBox = document.createElement('div');
            messageBox.classList.add('fixed', 'inset-0', 'bg-gray-800', 'bg-opacity-50', 'flex', 'items-center', 'justify-center', 'z-50');
            const boxColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            messageBox.innerHTML = `
                <div class="bg-white rounded-lg p-6 shadow-xl w-80 text-center">
                    <div class="p-4 ${boxColor} text-white rounded-t-md mb-4">
                        <p class="text-xl font-bold">${title}</p>
                    </div>
                    <p class="text-lg font-semibold text-gray-800 mb-4">${message}</p>
                    <button id="close-message" class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">Fechar</button>
                </div>
            `;
            document.body.appendChild(messageBox);
            document.getElementById('close-message').addEventListener('click', () => {
                messageBox.remove();
            });
        };

        // Function to clear the form
        const clearForm = () => {
            document.getElementById('orcamento-numero').textContent = '';
            document.getElementById('data-atual').textContent = '';
            document.getElementById('validade-input').value = '30 dias';
            document.getElementById('condicoes-pagamento-input').value = 'Avista';
            document.getElementById('status-select').value = 'Pendente';
            document.getElementById('cliente-nome').value = '';
            document.getElementById('cliente-email').value = '';
            document.getElementById('cliente-telefone').value = '';
            
            const itensTabela = document.getElementById('itens-tabela');
            itensTabela.innerHTML = '';
            document.getElementById('total-orcamento').textContent = 'R$ 0,00';
            
            // Re-generate budget number and date for a new one
            const data = new Date();
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear().toString().substring(2);
            document.getElementById('data-atual').textContent = `${dia}/${mes}/${data.getFullYear()}`;
            const numeroAleatorio = Math.floor(100 + Math.random() * 900);
            document.getElementById('orcamento-numero').textContent = `${dia}${mes}${ano}-${numeroAleatorio}`;
            
            // Add a single item row to start
            const addItem = document.getElementById('add-item-btn');
            addItem.click();
        };

        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for authentication
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Authentication error:", error);
                showMessage('Erro', `Falha na autenticação: ${error.message}`, 'error');
                return;
            }

            const itensTabela = document.getElementById('itens-tabela');
            const addItemBtn = document.getElementById('add-item-btn');
            const totalOrcamentoSpan = document.getElementById('total-orcamento');
            const dataAtualSpan = document.getElementById('data-atual');
            const orcamentoNumeroSpan = document.getElementById('orcamento-numero');
            const gerarPdfBtn = document.getElementById('gerar-pdf-btn');
            const salvarBtn = document.getElementById('salvar-btn');
            const voltarBtn = document.getElementById('voltar-btn');
            const validadeInput = document.getElementById('validade-input');
            const condicoesPagamentoInput = document.getElementById('condicoes-pagamento-input');
            const statusSelect = document.getElementById('status-select');
            
            // Setar data e número do orçamento
            const data = new Date();
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear().toString().substring(2);
            dataAtualSpan.textContent = `${dia}/${mes}/${data.getFullYear()}`;
            
            const numeroAleatorio = Math.floor(100 + Math.random() * 900);
            orcamentoNumeroSpan.textContent = `${dia}${mes}${ano}-${numeroAleatorio}`;
            
            let total = 0;

            const updateSubtotal = (row) => {
                const qtdInput = row.querySelector('.qtd');
                const valorUnitInput = row.querySelector('.valor-unit');
                const totalSpan = row.querySelector('.item-total');

                const qtd = parseFloat(qtdInput.value) || 0;
                const valorUnit = parseFloat(valorUnitInput.value) || 0;
                const subtotal = qtd * valorUnit;

                totalSpan.textContent = subtotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                return subtotal;
            };

            const updateTotal = () => {
                total = 0;
                document.querySelectorAll('#itens-tabela tr').forEach(row => {
                    const subtotalText = row.querySelector('.item-total').textContent.replace('R$', '').replace('.', '').replace(',', '.').trim();
                    total += parseFloat(subtotalText);
                });
                totalOrcamentoSpan.textContent = total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            };

            const addItem = (descricao = '', qtd = '', valorUnit = '') => {
                const newRow = document.createElement('tr');
                newRow.classList.add('bg-white', 'border-b', 'hover:bg-gray-50');
                newRow.innerHTML = `
                    <td class="px-6 py-4"><input type="text" value="${descricao}" class="descricao w-full px-2 py-1 border rounded-md focus:outline-none focus:ring-1 focus:ring-green-500"></td>
                    <td class="px-6 py-4"><input type="number" value="${qtd}" class="qtd w-20 px-2 py-1 border rounded-md focus:outline-none focus:ring-1 focus:ring-green-500 text-right"></td>
                    <td class="px-6 py-4"><input type="number" value="${valorUnit}" step="0.01" class="valor-unit w-24 px-2 py-1 border rounded-md focus:outline-none focus:ring-1 focus:ring-green-500 text-right"></td>
                    <td class="px-6 py-4 text-right item-total">R$ 0,00</td>
                    <td class="px-6 py-4 text-right">
                        <button class="remover-item-btn text-red-600 hover:text-red-800 transition-colors">Remover</button>
                    </td>
                `;
                itensTabela.appendChild(newRow);

                const qtdInput = newRow.querySelector('.qtd');
                const valorUnitInput = newRow.querySelector('.valor-unit');
                const removerBtn = newRow.querySelector('.remover-item-btn');

                const updateRowTotal = () => {
                    updateSubtotal(newRow);
                    updateTotal();
                };

                qtdInput.addEventListener('input', updateRowTotal);
                valorUnitInput.addEventListener('input', updateRowTotal);
                
                removerBtn.addEventListener('click', () => {
                    newRow.remove();
                    updateTotal();
                });

                updateSubtotal(newRow);
                updateTotal();
            };

            addItemBtn.addEventListener('click', () => addItem());

            // Gerar PDF de forma profissional
            gerarPdfBtn.addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let y = 20;

                // Faixa azul de cabeçalho
                const blueColor = [59, 130, 246]; // Cor azul similar ao botão (Tailwind)
                doc.setFillColor(...blueColor);
                doc.rect(0, 0, doc.internal.pageSize.getWidth(), 30, 'F');
                
                // Título e dados da empresa em branco
                doc.setFontSize(24);
                doc.setTextColor(255, 255, 255);
                doc.text("Orçamento", 105, y, null, null, "center");
                y += 10;
                doc.setFontSize(14);
                doc.text("AtomoTech", 105, y, null, null, "center");
                y += 10;
                
                // Mudar a cor do texto de volta para preto para o resto do documento
                doc.setTextColor(0, 0, 0);
                y += 5;

                // Adicionar o status com cor no canto superior direito
                const status = statusSelect.value;
                let statusColor = [0, 0, 0];
                const statusX = doc.internal.pageSize.getWidth() - 50;
                const statusY = 10;
                const statusWidth = 40;
                const statusHeight = 10;

                doc.setFontSize(10);
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                
                switch(status) {
                    case "Pendente":
                        statusColor = [255, 193, 7]; // Amarelo
                        doc.setFillColor(...statusColor);
                        doc.roundedRect(statusX, statusY, statusWidth, statusHeight, 2, 2, 'F');
                        doc.text(status.toUpperCase(), statusX + statusWidth / 2, statusY + statusHeight / 2 + 1, { align: 'center' });
                        break;
                    case "Aprovado":
                        statusColor = [40, 167, 69]; // Verde
                        doc.setFillColor(...statusColor);
                        doc.roundedRect(statusX, statusY, statusWidth, statusHeight, 2, 2, 'F');
                        doc.text(status.toUpperCase(), statusX + statusWidth / 2, statusY + statusHeight / 2 + 1, { align: 'center' });
                        break;
                    case "Rejeitado":
                        statusColor = [220, 53, 69]; // Vermelho
                        doc.setFillColor(...statusColor);
                        doc.roundedRect(statusX, statusY, statusWidth, statusHeight, 2, 2, 'F');
                        doc.text(status.toUpperCase(), statusX + statusWidth / 2, statusY + statusHeight / 2 + 1, { align: 'center' });
                        break;
                    case "Cancelado":
                        statusColor = [220, 53, 69]; // Vermelho
                        doc.setFillColor(...statusColor);
                        doc.roundedRect(statusX, statusY, statusWidth, statusHeight, 2, 2, 'F');
                        doc.text(status.toUpperCase(), statusX + statusWidth / 2, statusY + statusHeight / 2 + 1, { align: 'center' });
                        
                        // Faixa amarela diagonal
                        doc.setDrawColor(255, 193, 7);
                        doc.setLineWidth(1);
                        doc.line(statusX, statusY + statusHeight, statusX + statusWidth, statusY);
                        break;
                }
                
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');

                // Dados do orçamento
                doc.setFontSize(12);
                doc.text(`Orçamento: ${orcamentoNumeroSpan.textContent}`, 20, y);
                doc.text(`Data: ${dataAtualSpan.textContent}`, 105, y);
                y += 7;
                doc.text(`Validade: ${validadeInput.value}`, 20, y);
                doc.text(`Condições de Pagamento: ${condicoesPagamentoInput.value}`, 105, y);
                y += 7;
                doc.text(`Status: ${statusSelect.value}`, 20, y);
                y += 10;

                // Informações do Cliente
                doc.setFontSize(14);
                doc.text("Informações do Cliente", 20, y);
                y += 7;
                doc.setFontSize(12);
                doc.text(`Nome: ${document.getElementById('cliente-nome').value}`, 20, y);
                doc.text(`Email: ${document.getElementById('cliente-email').value}`, 105, y);
                y += 7;
                doc.text(`Telefone: ${document.getElementById('cliente-telefone').value}`, 20, y);
                y += 10;

                // Tabela de itens
                const headers = ["Descrição", "Qtd", "Valor Unit.", "Total"];
                const dataRows = [];
                document.querySelectorAll('#itens-tabela tr').forEach(row => {
                    const rowData = [
                        row.querySelector('.descricao').value,
                        row.querySelector('.qtd').value,
                        row.querySelector('.valor-unit').value,
                        row.querySelector('.item-total').textContent
                    ];
                    dataRows.push(rowData);
                });
                
                doc.autoTable({
                    head: [headers],
                    body: dataRows,
                    startY: y,
                    theme: 'grid',
                    styles: { cellPadding: 2, fontSize: 10 },
                    headStyles: { fillColor: blueColor, textColor: 255 }, // Cabeçalho azul com texto branco
                    columnStyles: {
                        0: { cellWidth: 'auto' },
                        1: { cellWidth: 20 },
                        2: { cellWidth: 30 },
                        3: { cellWidth: 30 }
                    }
                });

                // Total
                y = doc.autoTable.previous.finalY + 5;
                doc.setFontSize(12);
                doc.text(`Total: ${totalOrcamentoSpan.textContent}`, 180, y, null, null, "right");
                y += 20;

                // Assinatura
                doc.line(60, y, 150, y);
                y += 5;
                doc.text("Assinatura do Cliente", 105, y, null, null, "center");

                // Salvar o PDF
                const orcamentoNumero = orcamentoNumeroSpan.textContent.replace(/ /g, '_').replace('#', '');
                doc.save(`orcamento-${orcamentoNumero}.pdf`);
            });

            // Adicionar evento de salvar no Firebase
            salvarBtn.addEventListener('click', async () => {
                const userId = auth.currentUser?.uid || crypto.randomUUID();
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const orcamentoRef = doc(db, 'artifacts', appId, 'users', userId, 'orcamentos', orcamentoNumeroSpan.textContent);
                
                const itens = [];
                document.querySelectorAll('#itens-tabela tr').forEach(row => {
                    itens.push({
                        descricao: row.querySelector('.descricao').value,
                        qtd: parseFloat(row.querySelector('.qtd').value) || 0,
                        valorUnit: parseFloat(row.querySelector('.valor-unit').value) || 0,
                        totalItem: row.querySelector('.item-total').textContent
                    });
                });

                const orcamentoData = {
                    orcamentoNumero: orcamentoNumeroSpan.textContent,
                    data: dataAtualSpan.textContent,
                    validade: validadeInput.value,
                    condicoesPagamento: condicoesPagamentoInput.value,
                    status: statusSelect.value,
                    cliente: {
                        nome: document.getElementById('cliente-nome').value,
                        email: document.getElementById('cliente-email').value,
                        telefone: document.getElementById('cliente-telefone').value
                    },
                    itens: itens,
                    total: totalOrcamentoSpan.textContent,
                    createdAt: new Date()
                };

                try {
                    await setDoc(orcamentoRef, orcamentoData);
                    showMessage('Sucesso', 'Orçamento salvo com sucesso!');
                    clearForm();
                } catch (error) {
                    console.error("Erro ao salvar o documento:", error);
                    showMessage('Erro', 'Não foi possível salvar o orçamento. Tente novamente.', 'error');
                }
            });

            // Botão Voltar
            voltarBtn.addEventListener('click', () => {
                window.history.back();
            });

            // Adicionar um item inicial
            addItem();
        });
    </script>
</body>
</html>
