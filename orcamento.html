<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orçamento e OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center py-10 min-h-screen relative">

    <!-- Modal de Erro -->
    <div id="errorModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-96 text-center">
            <h2 class="text-xl font-bold text-white bg-red-500 rounded-t-lg p-3">Erro Crítico</h2>
            <div class="p-4">
                <p id="errorMessage" class="text-gray-700 mb-4">Não foi possível inicializar o Firebase. A funcionalidade de salvar não estará disponível.</p>
                <button id="closeModal" class="bg-blue-500 text-white rounded-md px-4 py-2 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Container Principal -->
    <div class="logo-container hidden"></div>
    <div class="w-full max-w-4xl bg-white rounded-lg shadow-xl p-8 md:p-12 z-10">
        <div class="flex flex-col items-center mb-6">
            <img src="https://placehold.co/100x100?text=Logo" alt="Logo" class="h-24 w-24 mb-4 rounded-full">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-2">Orçamento / OS</h1>
        </div>

        <form id="osForm" class="space-y-6">
            <!-- Informações do Cliente e OS -->
            <div class="bg-gray-100 p-6 rounded-lg border border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Informações do Cliente e OS</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="clientName" class="block text-sm font-medium text-gray-700">Nome do Cliente:</label>
                        <input type="text" id="clientName" name="clientName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                    </div>
                    <div>
                        <label for="clientPhone" class="block text-sm font-medium text-gray-700">Telefone:</label>
                        <input type="tel" id="clientPhone" name="clientPhone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                    </div>
                    <div>
                        <label for="clientEmail" class="block text-sm font-medium text-gray-700">Email:</label>
                        <input type="email" id="clientEmail" name="clientEmail" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                    </div>
                    <div>
                        <label for="osNumber" class="block text-sm font-medium text-gray-700">Número da OS:</label>
                        <input type="text" id="osNumber" name="osNumber" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" readonly>
                    </div>
                    <div>
                        <label for="osDate" class="block text-sm font-medium text-gray-700">Data:</label>
                        <input type="date" id="osDate" name="osDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                    </div>
                    <div>
                        <label for="paymentTerms" class="block text-sm font-medium text-gray-700">Condições de Pagamento:</label>
                        <input type="text" id="paymentTerms" name="paymentTerms" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                    </div>
                </div>
            </div>

            <!-- Itens de Serviço -->
            <div class="bg-gray-100 p-6 rounded-lg border border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Itens de Serviço</h2>
                <div id="serviceItemsContainer" class="space-y-4">
                    <!-- Item de serviço inicial, será clonado para novos itens -->
                    <div class="service-item grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="item-description-1" class="block text-sm font-medium text-gray-700">Descrição:</label>
                            <input type="text" id="item-description-1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="Ex: RJ45">
                        </div>
                        <div>
                            <label for="item-qty-1" class="block text-sm font-medium text-gray-700">Qtd:</label>
                            <input type="number" id="item-qty-1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" value="1">
                        </div>
                        <div>
                            <label for="item-price-1" class="block text-sm font-medium text-gray-700">Valor Unit.:</label>
                            <input type="number" id="item-price-1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" step="0.01" value="0.00">
                        </div>
                        <div class="md:col-span-1 flex items-end">
                            <button type="button" class="remove-item-btn bg-red-500 text-white rounded-md px-3 py-2 text-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 hidden">-</button>
                        </div>
                    </div>
                </div>
                <button type="button" id="addItemBtn" class="mt-4 bg-green-500 text-white rounded-md px-4 py-2 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">Adicionar Item</button>
            </div>

            <!-- Resumo e Botões de Ação -->
            <div class="bg-gray-100 p-6 rounded-lg border border-gray-200 flex flex-col items-end">
                <div class="text-lg font-bold text-gray-800 mb-4">
                    Total: <span id="totalValue">R$ 0,00</span>
                </div>
                <div class="flex space-x-4">
                    <button type="button" id="saveBtn" class="bg-blue-600 text-white rounded-md px-6 py-3 font-bold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-600">
                        Salvar
                    </button>
                    <button type="button" id="printBtn" class="bg-gray-500 text-white rounded-md px-6 py-3 font-bold hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Imprimir
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script type="module">
        // Global variables for Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase variables
        let app = null;
        let auth = null;
        let db = null;
        let userId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const osForm = document.getElementById('osForm');
            const addItemBtn = document.getElementById('addItemBtn');
            const serviceItemsContainer = document.getElementById('serviceItemsContainer');
            const totalValueSpan = document.getElementById('totalValue');
            const saveBtn = document.getElementById('saveBtn');
            const printBtn = document.getElementById('printBtn');
            const osNumberInput = document.getElementById('osNumber');
            const osDateInput = document.getElementById('osDate');
            const errorModal = document.getElementById('errorModal');
            const errorMessage = document.getElementById('errorMessage');
            const closeModalBtn = document.getElementById('closeModal');
            const firebaseAuthStatus = document.getElementById('firebaseAuthStatus');

            closeModalBtn.addEventListener('click', () => {
                errorModal.classList.add('hidden');
            });

            function showModal(message) {
                errorMessage.textContent = message;
                errorModal.classList.remove('hidden');
            }

            try {
                if (firebaseConfig) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    // Sign in with custom token if provided, otherwise sign in anonymously
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log('Usuário autenticado. UID:', userId);
                        } else {
                            userId = null;
                            console.log('Nenhum usuário autenticado.');
                        }
                    });
                } else {
                    showModal("Firebase não configurado. Por favor, forneça as configurações do Firebase.");
                }
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                showModal(`Não foi possível inicializar o Firebase. A funcionalidade de salvar não estará disponível. Detalhes: ${error.message}`);
                return;
            }

            // Generate OS number and set current date on load
            osNumberInput.value = generateOsNumber();
            osDateInput.valueAsDate = new Date();

            function generateOsNumber() {
                const date = new Date();
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                const random = Math.floor(Math.random() * 10000);
                return `${day}${month}${year}-${random}`;
            }

            // Function to add new service item row
            addItemBtn.addEventListener('click', () => {
                const itemDiv = document.querySelector('.service-item').cloneNode(true);
                const inputs = itemDiv.querySelectorAll('input');
                inputs.forEach(input => input.value = '');
                itemDiv.querySelector('.remove-item-btn').classList.remove('hidden');
                serviceItemsContainer.appendChild(itemDiv);
            });

            // Event listener for removing service item
            serviceItemsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-item-btn')) {
                    e.target.closest('.service-item').remove();
                }
            });

            // Function to calculate and update total
            osForm.addEventListener('input', () => {
                let total = 0;
                const items = document.querySelectorAll('.service-item');
                items.forEach(item => {
                    const qty = parseFloat(item.querySelector('input[type="number"]:nth-of-type(1)').value) || 0;
                    const price = parseFloat(item.querySelector('input[type="number"]:nth-of-type(2)').value) || 0;
                    total += qty * price;
                });
                totalValueSpan.textContent = `R$ ${total.toFixed(2)}`;
            });
            
            // Function to save data to Firestore
            saveBtn.addEventListener('click', async () => {
                if (!db || !userId) {
                    showModal('Firebase não inicializado ou usuário não autenticado. A funcionalidade de salvar não está disponível.');
                    return;
                }

                try {
                    const osData = {
                        osNumber: osNumberInput.value,
                        osDate: osDateInput.value,
                        clientName: document.getElementById('clientName').value,
                        clientEmail: document.getElementById('clientEmail').value,
                        clientPhone: document.getElementById('clientPhone').value,
                        paymentTerms: document.getElementById('paymentTerms').value,
                        items: [],
                        total: parseFloat(totalValueSpan.textContent.replace('R$ ', '').replace(',', '.'))
                    };

                    const items = document.querySelectorAll('.service-item');
                    items.forEach(item => {
                        osData.items.push({
                            description: item.querySelector('input[placeholder="Ex: RJ45"]').value,
                            quantity: parseFloat(item.querySelector('input[type="number"]:nth-of-type(1)').value),
                            unitPrice: parseFloat(item.querySelector('input[type="number"]:nth-of-type(2)').value),
                        });
                    });

                    // Firestore path for user-specific data
                    const osCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/orcamentos`);
                    await addDoc(osCollectionRef, osData);
                    
                    console.log("Documento salvo com sucesso!");
                    alert("Documento salvo com sucesso!");
                    
                } catch (error) {
                    console.error("Erro ao salvar documento:", error);
                    showModal(`Erro ao salvar documento: ${error.message}`);
                }
            });

            // Print functionality
            printBtn.addEventListener('click', () => {
                window.print();
            });

        });
    </script>
</body>
</html>
